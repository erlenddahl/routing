using EnergyModule.Geometry.SimpleStructures;
using RoadNetworkRouting.Config;
using RoadNetworkRouting.Network;

namespace RoadNetworkRouting.Tests;

[TestClass]
public class FullRoutingTests
{
    private RoadNetworkRouter _router;

    [TestInitialize]
    public void Init()
    {
        var networkFile = "D:\\Lager\\RouteNetworkUpdater\\2023-01-09\\network.bin";
        _router = RoadNetworkRouter.LoadFrom(networkFile);
    }

    [TestMethod]
    public void PointAtNode()
    {
        var res = _router.Search(new Point3D(261079.2, 7041288.2), new Point3D(261807.7, 7041127.1), new RoutingConfig());
        Assert.AreEqual(62, res.DistanceToSourceVertex, 1);
        Assert.AreEqual(64, res.DistanceToTargetVertex, 1);

        Assert.AreEqual(916, res.RouteDistance, 1);
    }
}

/// <summary>
/// Tests for routing along a single route from Byåsen, Trondheim.
/// </summary>
[TestClass]
public class TinyRoutingTests
{
    private RoadNetworkRouter _router;

    [TestMethod]
    public void PointAtNode()
    {
        var res = _router.GetNearestLink(new Point3D(261079.2, 7041288.2), new RoutingConfig());
        Assert.AreEqual(335707, res.Link.LinkId);
        Assert.AreEqual(175, res.Link.Geometry.Length);

        Assert.AreEqual(3596, res.Nearest.Distance, 1);

        Assert.AreEqual(res.Nearest.X, res.Link.Geometry[^1].X);
        Assert.AreEqual(res.Nearest.Y, res.Link.Geometry[^1].Y);
    }

    [TestMethod]
    public void PointInsideLink()
    {
        var res = _router.GetNearestLink(new Point3D(261807.7, 7041127.1), new RoutingConfig());
        Assert.AreEqual(335707, res.Link.LinkId);
        Assert.AreEqual(175, res.Link.Geometry.Length);

        Assert.AreEqual(2680, res.Nearest.Distance, 1);
    }

    [TestMethod]
    public void PointAtOtherSide()
    {
        var res = _router.GetNearestLink(new Point3D(263800.5783, 7040584.6060), new RoutingConfig());
        Assert.AreEqual(335707, res.Link.LinkId);
        Assert.AreEqual(175, res.Link.Geometry.Length);

        Assert.AreEqual(0, res.Nearest.Distance);

        Assert.AreEqual(res.Nearest.X, res.Link.Geometry[0].X);
        Assert.AreEqual(res.Nearest.Y, res.Link.Geometry[0].Y);
    }

    [TestMethod]
    public void FromStartToEnd()
    {
        var res = _router.Search(new Point3D(263800.5783, 7040584.6060), new Point3D(261079.2, 7041288.2), new RoutingConfig());

        Assert.AreEqual(2811, new Point3D(261079.2, 7041288.2).DistanceTo2D(new Point3D(263800.5783, 7040584.6060)), 1);
        Assert.AreEqual(3596, res.RouteDistance, 1);
    }

    [TestMethod]
    public void FromEndToStart()
    {
        var res = _router.Search(new Point3D(261079.2, 7041288.2), new Point3D(263800.5783, 7040584.6060), new RoutingConfig());

        Assert.AreEqual(2811, new Point3D(261079.2, 7041288.2).DistanceTo2D(new Point3D(263800.5783, 7040584.6060)), 1);
        Assert.AreEqual(3596, res.RouteDistance, 1);
    }

    [TestInitialize]
    public void Init()
    {
        _router = new RoadNetworkRouter(new RoadLink[]
        {
            new()
            {
                FromNodeId = 0,
                ToNodeId = 1,
                LinkId = 335707,
                Cost = 5,
                ReverseCost = 5,
                Geometry = new Point3D[]
                {
                    new(263800.364, 7040584.665, 391.5134935),
                    new(263762.14, 7040594.92, 391.696),
                    new(263750.67, 7040594.81, 391.676),
                    new(263732.64, 7040587.44, 391.806),
                    new(263711.08, 7040571.13, 392.646),
                    new(263644.5, 7040549.33, 393.826),
                    new(263617.88, 7040538.03, 393.576),
                    new(263610.03, 7040535.75, 393.946),
                    new(263601.51, 7040535.9, 394.366),
                    new(263594.77, 7040538.74, 394.526),
                    new(263573.64, 7040554.43, 397.056),
                    new(263538.7, 7040572.4, 398.077),
                    new(263519.73, 7040578.52, 398.247),
                    new(263494.31, 7040582.4, 399.577),
                    new(263481.11, 7040586.26, 400.667),
                    new(263460.76, 7040593.96, 401.677),
                    new(263449.39, 7040599.87, 403.267),
                    new(263423.54, 7040616.9, 404.777),
                    new(263409.39, 7040626.3, 402.107),
                    new(263382.98, 7040639.08, 398.767),
                    new(263377.35, 7040644.97, 397.847),
                    new(263372.97, 7040659.22, 397.017),
                    new(263370.96, 7040661.49, 396.937),
                    new(263365.09, 7040663.04, 396.897),
                    new(263358.37, 7040661.02, 396.767),
                    new(263343.91, 7040651.48, 395.517),
                    new(263331.83, 7040641.4, 394.717),
                    new(263312.15, 7040623.87, 390.677),
                    new(263304.09, 7040614.12, 388.497),
                    new(263298.73, 7040600.08, 388.267),
                    new(263290.82, 7040589.47, 388.227),
                    new(263279.42, 7040580.45, 387.667),
                    new(263263.99, 7040571.12, 385.847),
                    new(263258.18, 7040564.58, 385.297),
                    new(263246.29, 7040543.37, 386.587),
                    new(263237.76, 7040527.75, 389.677),
                    new(263226.28, 7040510.86, 391.607),
                    new(263218.33, 7040488.31, 393.457),
                    new(263213.89, 7040481.3, 393.927),
                    new(263199.56, 7040467.25, 393.657),
                    new(263189.82, 7040444.06, 395.737),
                    new(263184.65, 7040435.33, 397.137),
                    new(263174.77, 7040427.21, 397.367),
                    new(263153.13, 7040415.57, 400.427),
                    new(263116.95, 7040418.64, 398.787),
                    new(263087.69, 7040416.76, 399.678),
                    new(263056.26, 7040414.6, 402.858),
                    new(263022.43, 7040415.87, 403.738),
                    new(262997.92, 7040421.73, 406.148),
                    new(262974.43, 7040427.12, 405.948),
                    new(262939.22, 7040435.51, 402.727),
                    new(262914.95, 7040438.61, 400.967),
                    new(262866.4, 7040440.96, 399.857),
                    new(262837.77, 7040446.25, 396.707),
                    new(262827.06, 7040450.54, 394.267),
                    new(262813.93, 7040466.21, 390.217),
                    new(262808.65, 7040480.46, 387.847),
                    new(262805.26, 7040515.7, 384.037),
                    new(262798.71, 7040533.47, 382.297),
                    new(262770.68, 7040574.94, 384.697),
                    new(262742.83, 7040620.85, 390.257),
                    new(262732, 7040636.03, 392.487),
                    new(262721.95, 7040645.93, 394.227),
                    new(262704.89, 7040654.12, 394.247),
                    new(262685.87, 7040656.49, 393.597),
                    new(262675.48, 7040655.65, 393.856),
                    new(262644, 7040650.26, 394.736),
                    new(262609.25, 7040642.53, 398.656),
                    new(262592.44, 7040640.28, 399.906),
                    new(262583.4, 7040642.06, 400.546),
                    new(262553.67, 7040653.79, 404.506),
                    new(262531.84, 7040659.99, 408.076),
                    new(262503.88, 7040663.21, 409.546),
                    new(262489.43, 7040663.2, 409.266),
                    new(262474.6, 7040660.65, 410.566),
                    new(262454.87, 7040654.07, 411.725),
                    new(262431.84, 7040642.81, 411.665),
                    new(262396.53, 7040623.67, 413.735),
                    new(262388.89, 7040620.6, 413.295),
                    new(262376.86, 7040619.86, 413.005),
                    new(262369.19, 7040621.8, 412.155),
                    new(262340.69, 7040633.18, 412.505),
                    new(262323.25, 7040646.03, 414.285),
                    new(262309.25, 7040663.05, 415.205),
                    new(262300.64, 7040677.6, 416.075),
                    new(262295.52, 7040689.45, 416.625),
                    new(262290.32, 7040711.07, 415.605),
                    new(262288.49, 7040714.76, 415.185),
                    new(262281.81, 7040718.96, 414.555),
                    new(262275.02, 7040719.46, 413.525),
                    new(262261.8, 7040715.67, 411.315),
                    new(262256.25, 7040712.91, 410.075),
                    new(262244.77, 7040702.05, 407.044),
                    new(262238.67, 7040698.29, 405.854),
                    new(262232.74, 7040697.23, 405.314),
                    new(262224.44, 7040699.21, 404.994),
                    new(262220.61, 7040701.75, 404.554),
                    new(262209.08, 7040713.86, 406.094),
                    new(262200.06, 7040718.55, 406.694),
                    new(262161.49, 7040722.57, 403.774),
                    new(262109.43, 7040729.19, 403.144),
                    new(262102.76, 7040729.48, 402.014),
                    new(262069.02, 7040723.91, 399.974),
                    new(262043.8, 7040720.05, 402.074),
                    new(262029.62, 7040716.24, 404.273),
                    new(262012.33, 7040708.8, 405.323),
                    new(261990.72, 7040698.11, 403.073),
                    new(261983.1, 7040698.52, 402.223),
                    new(261978.8, 7040701.08, 401.903),
                    new(261969.22, 7040717.79, 400.613),
                    new(261959.61, 7040746.31, 401.163),
                    new(261957.44, 7040760.44, 401.363),
                    new(261957.96, 7040780.09, 400.573),
                    new(261956.73, 7040792.36, 399.483),
                    new(261954.62, 7040799.52, 398.693),
                    new(261944.16, 7040824.61, 399.433),
                    new(261938.02, 7040857.14, 398.703),
                    new(261933.09, 7040866.91, 399.093),
                    new(261918.25, 7040889.2, 400.953),
                    new(261892.12, 7040925.49, 408.723),
                    new(261854.91, 7040977.33, 414.203),
                    new(261841.13, 7040991.42, 415.383),
                    new(261816.52, 7041011.47, 417.133),
                    new(261801.26, 7041029.54, 417.153),
                    new(261770.94, 7041070.51, 413.312),
                    new(261753.96, 7041091.95, 414.922),
                    new(261737.91, 7041115.44, 415.302),
                    new(261711.56, 7041148.71, 414.412),
                    new(261699.39, 7041168.49, 414.342),
                    new(261691.88, 7041180.45, 415.912),
                    new(261686.51, 7041184.57, 416.162),
                    new(261679.34, 7041185.87, 416.042),
                    new(261672.68, 7041184.99, 415.722),
                    new(261656.73, 7041175.89, 412.022),
                    new(261640.19, 7041165.99, 412.122),
                    new(261618.97, 7041142.33, 413.262),
                    new(261606.28, 7041120.25, 413.292),
                    new(261589.82, 7041097.28, 415.042),
                    new(261571.79, 7041075.96, 419.911),
                    new(261560.46, 7041066.52, 422.151),
                    new(261555.56, 7041065.36, 422.681),
                    new(261550.07, 7041067.82, 422.581),
                    new(261543.31, 7041080.5, 421.671),
                    new(261533.97, 7041091.46, 421.471),
                    new(261511.97, 7041109.87, 421.971),
                    new(261501.26, 7041114.35, 422.541),
                    new(261472.78, 7041119.47, 425.801),
                    new(261433.54, 7041126.91, 424.331),
                    new(261422.45, 7041126.73, 424.321),
                    new(261392.13, 7041122.75, 420.771),
                    new(261381.33, 7041123.88, 421.401),
                    new(261372.63, 7041127.57, 421.521),
                    new(261358.52, 7041137.7, 422.6),
                    new(261348.68, 7041148.26, 423.89),
                    new(261345.52, 7041156.14, 424.57),
                    new(261340.65, 7041179.27, 425.75),
                    new(261333.25, 7041195.52, 427.04),
                    new(261326.96, 7041201.09, 428.07),
                    new(261314.07, 7041207.45, 428.85),
                    new(261294.11, 7041211.1, 430.4),
                    new(261278.63, 7041209.4, 431.33),
                    new(261223.24, 7041193.54, 433.3),
                    new(261198.73, 7041188.35, 434.07),
                    new(261179.72, 7041188.61, 435.15),
                    new(261158.83, 7041193.31, 437.78),
                    new(261149.36, 7041192.71, 438.459),
                    new(261138.76, 7041186.81, 440.479),
                    new(261116.78, 7041168.79, 446.919),
                    new(261109.09, 7041165.7, 447.839),
                    new(261101.09, 7041165.15, 448.159),
                    new(261091.11, 7041169.25, 448.909),
                    new(261084.31, 7041179.92, 449.499),
                    new(261082.04, 7041195.76, 449.069),
                    new(261084.11, 7041213.63, 449.719),
                    new(261084.36, 7041226.53, 447.579)
                }
            }
        });
    }
}